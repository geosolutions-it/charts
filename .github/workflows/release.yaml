name: Release Charts

on:
  push:
    branches: [main]

env:
  HELM_VERSION: v3.18.2
  HELM_S3_VERSION: v0.17.1
  HELM_S3_BUCKET: geosolutions-charts/charts
  HELM_S3_REPO: charts
  CHARTS_URL: https://charts.geosolutionsgroup.com/charts

jobs:
  release-charts:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      id-token: write
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up Helm
      uses: azure/setup-helm@v4
      with:
        version: ${{ env.HELM_VERSION }}

    - name: Configure AWS credentials from OIDC
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: arn:aws:iam::227022658256:role/charts-s3-bucket-role
        aws-region: eu-west-2

    - name: Install Helm S3 plugin
      run: |
        helm plugin install https://github.com/hypnoglow/helm-s3.git --version ${{ env.HELM_S3_VERSION }}

    - name: Package and push charts to S3
      run: |
        set -euo pipefail

        repo_name="${HELM_S3_REPO}"
        repo_url="s3://${HELM_S3_BUCKET}"
        http_url="${CHARTS_URL}"

        # Initialize Helm repo index in S3 if it does not exist yet
        if ! aws s3api head-object --bucket "${HELM_S3_BUCKET}" --key "index.yaml" >/dev/null 2>&1; then
          echo "Initializing Helm repo at ${repo_url}"
          helm s3 init "$repo_url"
        fi

        if ! helm repo list | awk '{print $1}' | grep -qx "$repo_name"; then
          helm repo add "$repo_name" "$repo_url"
        fi

        helm repo update

        for chart_dir in */*/; do
          if [ -f "${chart_dir}Chart.yaml" ]; then
            chart_name=$(grep '^name:' "${chart_dir}Chart.yaml" | awk '{print $2}' | tr -d '"' | tr -d "'")
            chart_version=$(grep '^version:' "${chart_dir}Chart.yaml" | awk '{print $2}' | tr -d '"' | tr -d "'")
            echo "Processing $chart_name:$chart_version"

            if helm search repo "${repo_name}/${chart_name}" --version "$chart_version" 2>/dev/null | grep -q "${chart_name}"; then
              echo "Chart already exists in $repo_url, skipping..."
              continue
            fi

            helm package "$chart_dir"
            package_file="${chart_name}-${chart_version}.tgz"
            if [ -f "$package_file" ]; then
              helm s3 push "$package_file" "$repo_name"
              echo "âœ… Pushed $chart_name:$chart_version to $repo_url"
              rm "$package_file"
            fi
          fi
        done

        # Fix index.yaml URLs from s3:// to HTTP
        echo "Converting index.yaml URLs from s3:// to HTTP..."
        aws s3 cp "s3://${HELM_S3_BUCKET}/index.yaml" /tmp/index.yaml
        sed -i "s|s3://${HELM_S3_BUCKET}/|${http_url}/|g" /tmp/index.yaml
        aws s3 cp /tmp/index.yaml "s3://${HELM_S3_BUCKET}/index.yaml"
        echo "âœ… Updated index.yaml with HTTP URLs"

    - name: Checkout GitOps Repository
      uses: actions/checkout@v4
      with:
        repository: geosolutions-it/gitops-dev
        token: ${{ secrets.GITOPS_DEV_TOKEN }}
        path: gitops-dev

    - name: Deploy to Dev (GitOps)
      run: |
        cd gitops-dev
        git config user.name "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

        repo_url="${CHARTS_URL}"

        changes_made=false
        for chart_dir in ../*/*/; do
          if [ -f "${chart_dir}Chart.yaml" ]; then
            chart_name=$(grep '^name:' "${chart_dir}Chart.yaml" | awk '{print $2}' | tr -d '"' | tr -d "'")
            chart_version=$(grep '^version:' "${chart_dir}Chart.yaml" | awk '{print $2}' | tr -d '"' | tr -d "'")

            if [ -d "apps/$chart_name" ]; then
              current_version=$(grep 'targetRevision:' "apps/$chart_name/application.yaml" | head -1 | awk '{print $2}' | tr -d '"' | tr -d "'")
              if [ "$current_version" = "$chart_version" ]; then
                echo "$chart_name version $chart_version is already deployed, skipping..."
                continue
              fi
              echo "Updating $chart_name from $current_version to $chart_version in GitOps repository"
              sed -i "0,/targetRevision: .*/s/targetRevision: .*/targetRevision: $chart_version/" "apps/$chart_name/application.yaml"
              sed -i "0,/repoURL: .*/s|repoURL: .*|repoURL: $repo_url|" "apps/$chart_name/application.yaml"
              git add "apps/$chart_name/application.yaml"
              git commit -m "chore: update $chart_name chart version from $current_version to $chart_version"
              changes_made=true
              echo "Updated $chart_name to version $chart_version"
            else
              echo "App directory for $chart_name not found in GitOps repository"
            fi
          fi
        done

        if [ "$changes_made" = true ]; then
          git push origin HEAD
          echo "âœ… GitOps repository updated successfully"
        else
          echo "ðŸ“„ No version changes needed - all charts are already at the correct versions"
        fi
