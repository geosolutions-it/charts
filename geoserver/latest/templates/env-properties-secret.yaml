{{- define "geoserver.envPropertiesContent" -}}
  {{- $root := . -}}
  {{- $entries := $root.Values.geoserver.env_properties | default list -}}
  {{- if not (eq (kindOf $entries) "slice") -}}
    {{- fail "geoserver.env_properties must be a list" -}}
  {{- end -}}
  {{- range $entries -}}
    {{- $name := required "geoserver.env_properties[].name is required" .name -}}
    {{- $external := default false .external -}}
    {{- if $external -}}
      {{- $secretName := required (printf "geoserver.env_properties[%s].value (secret name) is required when external=true" $name) .value -}}
      {{- $key := $name -}}
      {{- $secret := lookup "v1" "Secret" $root.Release.Namespace $secretName -}}
      {{- if $secret -}}
        {{- $raw := index $secret.data $key -}}
        {{- if $raw -}}
{{ printf "%s=%s" $name ($raw | b64dec) }}
        {{- else -}}
          {{- fail (printf "env_properties entry %s: key %s not found in secret %s" $name $key $secretName) -}}
        {{- end -}}
      {{- else -}}
        {{- fail (printf "env_properties entry %s: secret %s not found in namespace %s" $name $secretName $root.Release.Namespace) -}}
      {{- end -}}
    {{- else -}}
{{ printf "%s=%v" $name (required (printf "geoserver.env_properties[%s].value is required when external=false" $name) .value) }}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- $envProps := include "geoserver.envPropertiesContent" . -}}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "geoserver.fullname" . }}-env-properties
data:
  environment.properties: {{ $envProps | b64enc }}
